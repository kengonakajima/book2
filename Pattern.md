# オンラインゲームのの典型的な作り方ぜんぶをリスト化

以下、ゲームのだいたいの内容について、
クラサバ/P2Pで典型的な実装パターンとパケットの内容の構成、インフラの構成、
簡単な見積もりを500文字~1000文字ぐらい+図を2個ぐらいで解説、全て列挙する。
いまわかっているゲームジャンルのほとんどについて、
実装仕様のたたき台になるようなもの。


最初h,ジャンルと実装方法のマトリックスで整理しようとしたが、無理だった。。ので、個別のゲームに似てるものを列挙していく方法にしてみる。

## 実装パターン
- A: クラウドロジック、クラウド描画 (CL-CR): ゲームロジックも描画もクラウドインフラで行い、映像を送信する(クラウドゲーミング)
- B: クラウドロジック、ローカル描画 (CL-LR): ゲームロジックをクラウドインフラで行い、端末側で描画だけする。(MMOやマイクラのRealm)
- C: リモートロジック、ローカル描画 (RL-LR): ゲームロジックは誰か別のユーザーの端末でやり、各端末で描画をする。(多くのスマホゲー)　通信はP2Pまたはリレーを使う。
- D: ローカルロジック、ローカル描画 (LL-LR): 通信をしないマルチプレイゲーム

ネットコードが必要なのはB,C。ネットコードを実装しない方法については割愛。

UEのサーバーモードやUnityのheadlessモードのように、
Cパターンのサーバー出力を用いる場合はCのホストがクラウドにあるだけなのでCの一部とする。
Cで対応できる人数は帯域や処理負荷の関係から限られるのと、チートしやすいので、
Bは大人数+チート防止のために使われる。

CとBは要件が違うので、CとBの両方についてこうするというのが示されたら良い。

Bはサーバーが、許される範囲でゲームの更新をできるだけ多くクライアントに送りたい。
何をどれだけ送ることができるか?送らないことができるか?どうやって?を考える。
サーバーが電ぷちにならないので、バグらない限りサーバーは正常終了を期待できる。

Cはホスト型とフルメッシュ型がある。ホスト型はシンプルで簡単。考えることはBと同じ。
ホスト型はホストになってる端末が突然電ぷちやネット切断するので、その対処をどうするか。通常は無視。
フルメッシュはレイテンシを減らせる利点や、ホストが落ちた時の移行がしやすいとされてきたが、
ホスト型でも同じことができるので今は必要がない。

端末から送信するのは300から500Kbps ( 40から70KBytes/sec ) 以下におさえたい。
サーバーから送るのも1人あたりはその程度におさえたい。
それだけの量のパケットを処理するCPU負荷自体は端末側は大したこと無い。サーバー側は人数による。


# 例: ディアブロ的なハクスラ
```
プレイヤー数: Cなら4~10　Bなら~100
敵の数: Cなら30から200,　Bなら~1000
主に動くもの: 敵。95%は敵の位置や状態の更新。(id32,x32,y32,z32,status32)で20バイト。次がプレイヤーの更新。
ベース: 100個の敵の更新(20バイト)を毎秒60回送ると 100x20x60=120KB/s (1Mbps)  これに人数をかける。
目標: これを5分の1に減らして1人あたり24KB/sぐらいにしたい。
基本的な手段: 送信間隔を10分の1にする(6フレームに1回)。　素直に実装するとゲスト側で動きがカクカクする(課題)。 Bならnearcastも使える。
課題への対策:　単純に同期のEaseを入れる。ゲストにもホストと同じロジックを入れて敵を先行して動かし、位置がずれたら上書きする。
決めの問題: 敵への攻撃をホストで判定するかゲストで判定するか。Bはホスト一択。Cはゲストでやるとラグの感じが小さいのでおすすめ。
```


# パターン一覧

- 地形変更ありオープンワールド: マイクラ
- ioゲーム(agar.io, snowball.io, ボンバーマン的なPvP)
- super mario makerの COOPモード
- 2d sandbox: Terraria
- 2d platformer jump: metroidvania
- sim city / factorio
- MMOじゃないモンハン
- PUBG
- MOBA: LoL
- FPS, 地形変わらないか、破壊だけのquake的なやつ
- 塗り/陣取り  splatoon
- 少人数PvP スマブラ
- ボンバーマン
- ぷよぷよの対戦
- tetris 99
- FIFA的なスポーツゲーム
- 無双
- ディアブロ的なハクスラ
- クラロワ
- MMORPG
- マリカー
- ストリートファイター
- マリオテニス
- turn based : 囲碁将棋麻雀
- RTS: Age of empires
- マルチプレイの音ゲーってあるんかな
